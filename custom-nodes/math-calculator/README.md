# Math Calculator Node

一个功能强大的 Node-RED 数学计算节点，支持多种数学运算。

## 功能特性

- ✅ 支持基本运算：加法、减法、乘法、除法
- ✅ 支持高级运算：取模、幂运算、平方根
- ✅ 支持数学函数：绝对值、向下取整、向上取整、四舍五入
- ✅ 灵活的操作数配置：支持消息属性、流程变量、全局变量
- ✅ 可配置的精度控制
- ✅ 完善的错误处理

## 安装

### 方法1: 本地安装（开发测试）

1. 将 `math-calculator` 文件夹复制到 Node-RED 的用户目录下的 `nodes` 文件夹：
   ```bash
   cp -r custom-nodes/math-calculator ~/.node-red/nodes/
   ```

2. 重启 Node-RED

### 方法2: 通过 npm 安装（如果发布到 npm）

```bash
npm install node-red-contrib-math-calculator
```

### 方法3: 配置 nodesDir（开发环境）

在启动 Node-RED 时，可以通过设置 `nodesDir` 配置项来指定节点目录：

```javascript
// settings.js
module.exports = {
    nodesDir: '/path/to/custom-nodes'
}
```

## 使用方法

### 基本用法

1. 在 Node-RED 编辑器中，从左侧面板拖拽 "Math Calculator" 节点到画布
2. 双击节点打开配置面板
3. 选择运算类型（如：加法）
4. 配置操作数1（默认从 `msg.payload` 获取）
5. 配置操作数2（可以是固定数字或从消息/变量获取）
6. 配置结果存储位置（默认存储到 `msg.payload`）
7. 点击"完成"保存配置

### 配置选项

- **运算类型**: 选择要执行的数学运算
- **操作数1**: 第一个操作数的来源（默认为 `payload`）
- **操作数2**: 第二个操作数，可以是：
  - 固定数字
  - 消息属性（如 `msg.value`）
  - 流程变量（如 `flow.count`）
  - 全局变量（如 `global.total`）
- **结果属性**: 计算结果存储的消息属性（默认为 `payload`）
- **四舍五入**: 是否将结果四舍五入到最近的整数
- **小数精度**: 指定结果的小数位数（仅在未勾选"四舍五入"时有效）

### 示例流程

#### 示例1: 简单加法
```
[Inject] -> [Math Calculator: 加法, 操作数2=10] -> [Debug]
输入: {payload: 5}
输出: {payload: 15}
```

#### 示例2: 计算平均值
```
[Inject] -> [Function: 设置 msg.sum 和 msg.count] 
         -> [Math Calculator: 除法, 操作数1=sum, 操作数2=count, 结果属性=avg] 
         -> [Debug]
```

#### 示例3: 幂运算
```
[Inject] -> [Math Calculator: 幂运算, 操作数2=2] -> [Debug]
输入: {payload: 3}
输出: {payload: 9}  // 3^2 = 9
```

## 支持的运算类型

| 运算类型 | 符号 | 说明 | 需要操作数2 |
|---------|------|------|------------|
| 加法 | + | 两个数相加 | 是 |
| 减法 | - | 第一个数减去第二个数 | 是 |
| 乘法 | × | 两个数相乘 | 是 |
| 除法 | ÷ | 第一个数除以第二个数 | 是 |
| 取模 | % | 第一个数对第二个数取模 | 是 |
| 幂运算 | ^ | 第一个数的第二个数次方 | 是 |
| 平方根 | √ | 计算第一个数的平方根 | 否 |
| 绝对值 | \|x\| | 计算第一个数的绝对值 | 否 |
| 向下取整 | ⌊x⌋ | 向下取整 | 否 |
| 向上取整 | ⌈x⌉ | 向上取整 | 否 |
| 四舍五入 | ≈ | 四舍五入到最近的整数 | 否 |

## 错误处理

节点会在以下情况输出错误：
- 操作数不是有效数字
- 除数为零
- 模数为零
- 对负数开平方根
- 无法获取操作数值

## 开发

### 文件结构

```
math-calculator/
├── math-calculator.js    # 节点运行时逻辑
├── math-calculator.html  # 节点编辑界面
├── package.json         # 节点包配置
└── README.md           # 说明文档
```

### 测试

1. 启动 Node-RED
2. 在编辑器中添加节点
3. 创建测试流程并验证功能

## 许可证

Apache-2.0
